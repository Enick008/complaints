[⚠️ Suspicious Content] <!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการเรื่องร้องเรียน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f0f9ff;
    }
    header img {
      height: 100px;
      width: auto;
      margin: auto;
    }
    .tab-active {
      border-bottom: 2px solid #007aff;
      color: #007aff;
    }
    .modal-bg {
      background: rgba(0,0,0,0.3);
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <header class="bg-blue-100 text-center p-4">
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Seal_of_Ko_Samui.png" alt="โลโก้">
    <nav class="mt-4 flex justify-center space-x-6">
      <button class="tab-active" onclick="showTab('reportTab', event)">รับแจ้งและรายงานผล</button>
      <button onclick="showTab('statsTab', event)">สถิติ</button>
    </nav>
  </header>

  <main class="flex-1 p-4">
    <div id="errorMsg"></div>
    <!-- แท็บ รับแจ้ง -->
    <div id="reportTab">
      <form id="complaintForm" class="bg-white rounded-xl p-4 shadow mb-6">
        <h2 class="text-xl font-bold mb-4">ฟอร์มรับเรื่องร้องเรียน</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" placeholder="ชื่อ" name="name" required class="border p-2 rounded">
          <input type="text" placeholder="ที่อยู่" name="address" required class="border p-2 rounded">
          <select name="subdistrict" required class="border p-2 rounded">
            <option>แม่น้ำ</option><option>บ่อผุด</option><option>มะเร็ต</option>
            <option>หน้าเมือง</option><option>ลิปะน้อย</option><option>ตลิ่งงาม</option><option>อ่างทอง</option>
          </select>
          <input type="tel" placeholder="เบอร์โทรศัพท์" name="phone" class="border p-2 rounded">
          <select name="department" required class="border p-2 rounded">
            <option>งานบริหารทั่วไป</option>
            <option>ฝ่ายปรับปรุงคุณภาพน้ำ</option>
            <option>ฝ่ายจัดการสิ่งแวดล้อมด้านวัสดุใช้แล้ว</option>
          </select>
          <input type="text" placeholder="ผู้รับผิดชอบ" name="staff" class="border p-2 rounded">
          <select name="status" required class="border p-2 rounded">
            <option>อยู่ระหว่างดำเนินการ</option>
            <option>ดำเนินการแล้ว</option>
          </select>
        </div>
        <textarea name="detail" rows="3" placeholder="รายละเอียดเรื่องร้องเรียน" class="w-full border p-2 rounded mt-4"></textarea>
        <div id="actionResult" class="text-sm mt-2"></div>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 mt-4 rounded hover:bg-blue-600">บันทึก</button>
      </form>

      <div class="mb-4 flex flex-col md:flex-row md:space-x-4">
        <input type="text" id="searchInput" placeholder="ค้นหา (ชื่อ/ฝ่าย/สถานะ/ID)..." class="border p-2 rounded w-full md:w-1/2 mb-2 md:mb-0">
        <select id="statusFilter" class="border p-2 rounded w-full md:w-48">
          <option value="">ทั้งหมด</option>
          <option value="อยู่ระหว่างดำเนินการ">อยู่ระหว่างดำเนินการ</option>
          <option value="ดำเนินการแล้ว">ดำเนินการแล้ว</option>
        </select>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full bg-white rounded-xl shadow overflow-hidden text-sm">
          <thead class="bg-blue-200">
            <tr>
              <th class="p-2">ชื่อ</th>
              <th class="p-2">ฝ่าย</th>
              <th class="p-2">สถานะ</th>
              <th class="p-2">วันที่ดำเนินการ</th>
              <th class="p-2">ID</th>
              <th class="p-2">จัดการ</th>
            </tr>
          </thead>
          <tbody id="complaintTable"></tbody>
        </table>
      </div>
    </div>

    <!-- แท็บ สถิติ -->
    <div id="statsTab" class="hidden">
      <div id="statsSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-200 rounded-xl p-4 text-center">
          <div class="text-3xl font-bold" id="totalCases">0</div>
          <div>เรื่องร้องเรียนทั้งหมด</div>
        </div>
        <div class="bg-blue-100 rounded-xl p-4 text-center">
          <div class="text-3xl font-bold" id="doneCases">0</div>
          <div>ดำเนินการแล้ว</div>
        </div>
        <div class="bg-blue-50 rounded-xl p-4 text-center">
          <div class="text-3xl font-bold" id="inProgressCases">0</div>
          <div>อยู่ระหว่างดำเนินการ</div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded-xl shadow">
          <h3 class="font-bold mb-2">จำนวนร้องเรียนรายเดือน</h3>
          <canvas id="monthlyChart"></canvas>
        </div>
        <div class="bg-white p-4 rounded-xl shadow">
          <h3 class="font-bold mb-2">แยกตามฝ่ายรับผิดชอบ</h3>
          <canvas id="deptChart"></canvas>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-blue-100 text-center text-sm text-blue-800 p-4">
    ©2025 ระบบบริหารจัดการงานกองช่างสุขาภิบาล โดย นายธีรศักดิ์ พูลเขาล้าน
  </footer>

  <!-- Modal edit complaint -->
  <div id="editModal" class="modal-bg hidden">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
      <h3 class="text-lg font-bold mb-4">แก้ไขสถานะเรื่องร้องเรียน</h3>
      <form id="editForm">
        <input type="hidden" name="id" id="editId">
        <div class="mb-4">
          <label class="block font-bold mb-1">สถานะ</label>
          <select name="status" id="editStatus" class="border p-2 rounded w-full">
            <option>อยู่ระหว่างดำเนินการ</option>
            <option>ดำเนินการแล้ว</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block font-bold mb-1">รายละเอียด</label>
          <textarea name="detail" id="editDetail" rows="2" class="border p-2 rounded w-full"></textarea>
        </div>
        <div class="mb-4">
          <label class="block font-bold mb-1">ผู้รับผิดชอบ</label>
          <input type="text" name="staff" id="editStaff" class="border p-2 rounded w-full">
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeEditModal()" class="bg-gray-200 px-4 py-2 rounded">ยกเลิก</button>
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allComplaints = [];
    let monthlyChart, deptChart;

    function showTab(id, event) {
      document.getElementById('reportTab').classList.add('hidden');
      document.getElementById('statsTab').classList.add('hidden');
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
      if (event) event.target.classList.add('tab-active');
      if (id === 'statsTab') loadStatsAndCharts();
    }

    // ---- ตารางร้องเรียน ค้นหา ฟิลเตอร์ แก้ไข ลบ ----
    function renderComplaintTable() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const tbody = document.getElementById("complaintTable");
      tbody.innerHTML = "";
      const filtered = allComplaints.filter(r => {
        const matchStatus = !status || r.status === status;
        const text = [r.name, r.department, r.status, r.id].join(" ").toLowerCase();
        const matchSearch = !search || text.includes(search);
        return matchStatus && matchSearch;
      });
      filtered.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2">${r.name}</td>
          <td class="p-2">${r.department}</td>
          <td class="p-2">${r.status}</td>
          <td class="p-2">${r.finishedDate ? new Date(r.finishedDate).toLocaleString('th-TH') : '-'}</td>
          <td class="p-2">${r.id || '-'}</td>
          <td class="p-2 flex gap-1 justify-center">
            <button onclick="openEditModal('${r.id}')" class="bg-yellow-100 text-yellow-800 px-2 rounded">แก้ไข</button>
            <button onclick="deleteComplaint('${r.id}')" class="bg-red-100 text-red-600 px-2 rounded">ลบ</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function loadComplaints() {
  fetch("https://script.google.com/macros/s/AKfycbw4LM0Ig-Pr1VhiheafQfX3hu8rzwWZhPUXa1n17oO7rq6OQJ6WTjcoOsyrCVLdRww/exec?action=getAllComplaints")
    .then(res => {
      if (!res.ok) throw new Error('Network response was not ok');
      return res.json();
    })
    .then(result => {
      if (!result.success) {
        showError("API ไม่ตอบกลับ กรุณาตรวจสอบ Server");
        allComplaints = [];
      } else {
        allComplaints = result.data || [];
        showError("");
      }
      renderComplaintTable();
    })
    .catch(err => {
      showError("โหลดข้อมูลไม่สำเร็จ: " + err.message);
      allComplaints = [];
      renderComplaintTable();
    });
}

function showError(msg) {
  let div = document.getElementById("errorMsg");
  if (!div) {
    div = document.createElement("div");
    div.id = "errorMsg";
    div.className = "text-red-600 bg-red-50 p-2 mb-2 rounded";
    document.querySelector("main").prepend(div);
  }
  div.textContent = msg || "";
  div.style.display = msg ? "" : "none";
  if (msg) window.scrollTo({top:0, behavior:"smooth"});
}
    document.getElementById("searchInput").addEventListener("input", renderComplaintTable);
    document.getElementById("statusFilter").addEventListener("change", renderComplaintTable);

    // --- Modal สำหรับแก้ไข ---
    function openEditModal(id) {
  if (!id) return; // ป้องกัน modal เด้ง
  const c = allComplaints.find(r => r.id === id);
  if (!c) return alert("ไม่พบข้อมูลรายการนี้");
  document.getElementById('editId').value = c.id;
  document.getElementById('editStatus').value = c.status;
  document.getElementById('editDetail').value = c.detail || '';
  document.getElementById('editStaff').value = c.staff || '';
  document.getElementById('editModal').classList.remove('hidden');
}

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }
    document.getElementById('editForm').onsubmit = function(e) {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const status = document.getElementById('editStatus').value;
      const detail = document.getElementById('editDetail').value;
      const staff = document.getElementById('editStaff').value;
      fetch("https://script.google.com/macros/s/AKfycbw4LM0Ig-Pr1VhiheafQfX3hu8rzwWZhPUXa1n17oO7rq6OQJ6WTjcoOsyrCVLdRww/exec?action=editComplaint", {
        method: "POST",
        body: JSON.stringify({ id, status, detail, staff })
      })
      .then(res => res.json())
      .then(res => {
        if(res.success) {
          closeEditModal();
          loadComplaints();
          loadStatsAndCharts();
        } else {
          alert("เกิดข้อผิดพลาด: " + res.message);
        }
      });
    };

    function deleteComplaint(id) {
      if (!confirm("คุณต้องการลบรายการนี้ใช่หรือไม่?")) return;
      fetch("https://script.google.com/macros/s/AKfycbw4LM0Ig-Pr1VhiheafQfX3hu8rzwWZhPUXa1n17oO7rq6OQJ6WTjcoOsyrCVLdRww/exec?action=deleteComplaint", {
        method: "POST",
        body: JSON.stringify({ id })
      })
        .then(res => res.json())
        .then(res => {
          if(res.success) {
            loadComplaints();
            loadStatsAndCharts();
          } else {
            alert("เกิดข้อผิดพลาด: " + res.message);
          }
        });
    }

    // ---- กราฟ & สถิติ ----
    function loadStatsAndCharts() {
      fetch("https://script.google.com/macros/s/AKfycbw4LM0Ig-Pr1VhiheafQfX3hu8rzwWZhPUXa1n17oO7rq6OQJ6WTjcoOsyrCVLdRww/exec?action=getAllComplaints")
        .then(res => res.json())
        .then(result => {
          const data = result.data || [];
          document.getElementById("totalCases").textContent = data.length;
          document.getElementById("doneCases").textContent = data.filter(r=>r.status==="ดำเนินการแล้ว").length;
          document.getElementById("inProgressCases").textContent = data.filter(r=>r.status==="อยู่ระหว่างดำเนินการ").length;

          // ----- กราฟรายเดือน -----
          const monthMap = {};
          data.forEach(r=>{
            const d = new Date(r.timestamp);
            const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            if(!monthMap[ym]) monthMap[ym] = {all:0, inProgress:0};
            monthMap[ym].all++;
            if(r.status==="อยู่ระหว่างดำเนินการ") monthMap[ym].inProgress++;
          });
          const months = Object.keys(monthMap).sort();
          const allCases = months.map(m=>monthMap[m].all);
          const inProgress = months.map(m=>monthMap[m].inProgress);

          if(monthlyChart) monthlyChart.destroy();
          monthlyChart = new Chart(document.getElementById('monthlyChart'), {
            type: 'bar',
            data: {
              labels: months.map(m=>`${m.substr(5,2)}/${m.substr(0,4)}`),
              datasets: [
                { label: 'ร้องเรียนทั้งหมด', data: allCases, backgroundColor: '#60a5fa' },
                { label: 'อยู่ระหว่างดำเนินการ', data: inProgress, backgroundColor: '#93c5fd' }
              ]
            },
            options: { responsive: true, plugins: { legend: { position:'bottom' } } }
          });

          // ----- กราฟวงกลมฝ่าย -----
          const deptMap = {};
          data.forEach(r => {
            deptMap[r.department] = (deptMap[r.department]||0) + 1;
          });
          const depts = Object.keys(deptMap);
          const deptCounts = depts.map(d=>deptMap[d]);
          if(deptChart) deptChart.destroy();
          deptChart = new Chart(document.getElementById('deptChart'), {
            type: 'doughnut',
            data: {
              labels: depts,
              datasets: [{ data: deptCounts, backgroundColor: ['#60a5fa', '#93c5fd', '#bfdbfe', '#c7d2fe'] }]
            },
            options: { responsive: true, plugins: { legend: { position:'bottom' } } }
          });
        });
    }

    // โหลดข้อมูลตารางและสถิติครั้งแรก
    window.onload = function() {
      loadComplaints();
      loadStatsAndCharts();
    };

    // --- Form Handler (บันทึกข้อมูลใหม่) ---
    document.getElementById("complaintForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = new FormData(e.target);
      const data = {};
      form.forEach((v, k) => data[k] = v);

      document.getElementById("actionResult").textContent = "กำลังบันทึก...";

      fetch("https://script.google.com/macros/s/AKfycbw4LM0Ig-Pr1VhiheafQfX3hu8rzwWZhPUXa1n17oO7rq6OQJ6WTjcoOsyrCVLdRww/exec?action=addComplaint", {
        method: "POST",
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(res => {
          document.getElementById("actionResult").textContent = res.success ? "บันทึกสำเร็จ" : "เกิดข้อผิดพลาด";
          if (res.success) e.target.reset();
          loadComplaints();
          loadStatsAndCharts();
        });
    });
  </script>
</body>
</html>
