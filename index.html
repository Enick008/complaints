<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Prompt', sans-serif; }
    header img {
      height: 100px;
      width: auto;
    }
  </style>
</head>
<body class="bg-red-50">
  <header class="text-center py-4 bg-white shadow">
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Seal_of_Ko_Samui.png" alt="Seal of Ko Samui" class="mx-auto">
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <section class="bg-white rounded-xl shadow-md p-6 mb-6">
      <h2 class="text-2xl font-bold text-red-700 mb-4">üìã ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
      <form id="complaintForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="complaintId" />

        <div><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="date" id="date" class="w-full border rounded p-2" /></div>
        <div><label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏•‡∏á‡∏£‡∏±‡∏ö</label><input type="text" id="regNumber" class="w-full border rounded p-2" /></div>
        <div><label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="name" class="w-full border rounded p-2" /></div>
        <div><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input type="text" id="address" class="w-full border rounded p-2" /></div>
        <div>
          <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
          <select id="subdistrict" class="w-full border rounded p-2">
            <option>‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥</option>
            <option>‡∏ö‡πà‡∏≠‡∏ú‡∏∏‡∏î</option>
            <option>‡∏•‡∏¥‡∏õ‡∏∞‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option>‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏°</option>
            <option>‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏ï</option>
            <option>‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
            <option>‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á</option>
          </select>
        </div>
        <div><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="phone" class="w-full border rounded p-2" /></div>
        <div>
          <label>‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
          <select id="department" class="w-full border rounded p-2">
            <option>‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
            <option>‡∏ù‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥</option>
            <option>‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß</option>
          </select>
        </div>
        <div>
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select id="status" class="w-full border rounded p-2">
            <option>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
          </select>
        </div>
        <div><label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label><input type="text" id="assignee" class="w-full border rounded p-2" /></div>
        <div class="md:col-span-2">
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
          <textarea id="detail" rows="3" class="w-full border rounded p-2"></textarea>
        </div>
        <div class="md:col-span-2 text-right">
          <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
      </form>
    </section>

    <section class="bg-white rounded-xl shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold text-red-700 mb-4">üìë ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
      <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="text" id="searchInput" class="col-span-3 border rounded p-2" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö ‡∏ï‡∏≥‡∏ö‡∏• ‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">
        <button onclick="searchComplaints()" class="bg-red-600 text-white rounded px-4 py-2 hover:bg-red-700">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="flex space-x-2 mb-4">
        <button onclick="filterStatus('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button onclick="filterStatus('‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')" class="bg-yellow-200 hover:bg-yellow-300 px-3 py-1 rounded">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
        <button onclick="filterStatus('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')" class="bg-green-200 hover:bg-green-300 px-3 py-1 rounded">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full border text-sm">
          <thead class="bg-red-100">
            <tr>
              <th class="p-2 border">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="p-2 border">‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</th>
              <th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="p-2 border">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
              <th class="p-2 border">‡∏ï‡∏≥‡∏ö‡∏•</th>
              <th class="p-2 border">‡πÇ‡∏ó‡∏£</th>
              <th class="p-2 border">‡∏ù‡πà‡∏≤‡∏¢</th>
              <th class="p-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="p-2 border">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
              <th class="p-2 border">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
              <th class="p-2 border">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="complaintTable"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-white rounded-xl shadow-md p-6 mb-6" id="statsTab">
      <h2 class="text-xl font-semibold text-red-700 mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <canvas id="totalStatsChart"></canvas>
        <canvas id="monthlyStatsChart"></canvas>
      </div>
    </section>
  </main>

  <footer class="text-center py-4 text-sm bg-white border-t">¬©2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏ò‡∏µ‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏û‡∏π‡∏•‡πÄ‡∏Ç‡∏≤‡∏•‡πâ‡∏≤‡∏ô</footer>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxSZatYzQ-xIuWO5_F_D8qtPSXuy9rxxlkhogAkBBr4QG7fr_swhVpO1uHTQ5ZDoCtpRw/exec';
    const SHEET_ID = '1XtPNnfrpqFv57lhOI0JGw4eNpnotIj89pIGn7JDYR4g';

    document.getElementById("complaintForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const data = {
        action: "addComplaint",
        sheetId: SHEET_ID,
        callback: "handleResponse",
        receiveDate: document.getElementById("date").value,
        registrationNumber: document.getElementById("regNumber").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        district: document.getElementById("subdistrict").value,
        department: document.getElementById("department").value,
        status: document.getElementById("status").value,
        responsible: document.getElementById("assignee").value,
        details: document.getElementById("detail").value
      };

      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false,
        showConfirmButton: false
      });

      const query = new URLSearchParams(data).toString();
      const script = document.createElement('script');
      script.src = `${API_URL}?${query}`;
      document.body.appendChild(script);
    });

    function handleResponse(response) {
      Swal.close();
      if (response.success) {
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        document.getElementById("complaintForm").reset();
        loadComplaints();
      } else {
        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', response.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
      }
    }

   function renderComplaints(response) {
  const table = document.getElementById("complaintTable");
  table.innerHTML = "";
  window._allComplaints = response.data || [];

  if (response.success && Array.isArray(response.data)) {
    response.data.forEach(c => {
      const row = `<tr>
        <td class="border p-1">${c.receiveDate}</td>
        <td class="border p-1">${c.registrationNumber}</td>
        <td class="border p-1">${c.name}</td>
        <td class="border p-1">${c.address}</td>
        <td class="border p-1">${c.district}</td>
        <td class="border p-1">${c.phone}</td>
        <td class="border p-1">${c.department}</td>
        <td class="border p-1">${c.status}</td>
        <td class="border p-1">${c.responsible}</td>
        <td class="border p-1">${c.details}</td>
        <td class="border p-1 text-center">
          <button onclick="editComplaint('${c.id}')" class="text-blue-600">‚úèÔ∏è</button>
          <button onclick="deleteComplaint('${c.id}')" class="text-red-600 ml-1">üóë</button>
        </td>
      </tr>`;
      table.innerHTML += row;
    });
  }
}

function editComplaint(id) {
  const c = window._allComplaints.find(x => x.id === id);
  if (!c) return;
  document.getElementById("complaintId").value = c.id;
  document.getElementById("date").value = c.receiveDate;
  document.getElementById("regNumber").value = c.registrationNumber;
  document.getElementById("name").value = c.name;
  document.getElementById("phone").value = c.phone;
  document.getElementById("address").value = c.address;
  document.getElementById("subdistrict").value = c.district;
  document.getElementById("department").value = c.department;
  document.getElementById("status").value = c.status;
  document.getElementById("assignee").value = c.responsible;
  document.getElementById("detail").value = c.details;

  if (c.status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') {
    if (!document.getElementById("completionDate")) {
      const extraFields = document.createElement("div");
      extraFields.id = "completionFields";
      extraFields.classList.add("md:col-span-2", "grid", "grid-cols-1", "md:grid-cols-2", "gap-4", "mt-2");
      extraFields.innerHTML = `
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <input type="date" id="completionDate" class="w-full border rounded p-2" value="${c.completionDate || ''}" />
        </div>
        <div>
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <textarea id="completionDetails" class="w-full border rounded p-2" rows="2">${c.completionDetails || ''}</textarea>
        </div>
      `;
      document.getElementById("complaintForm").appendChild(extraFields);
    }
  }
}

function deleteComplaint(id) {
  Swal.fire({
    title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '‡∏•‡∏ö',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
  }).then(result => {
    if (result.isConfirmed) {
      const query = `action=deleteComplaint&id=${id}&sheetId=${SHEET_ID}&callback=handleResponse`;
      const script = document.createElement('script');
      script.src = `${API_URL}?${query}`;
      document.body.appendChild(script);
    }
  });
}

function searchComplaints() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const filtered = window._allComplaints.filter(c =>
    c.registrationNumber.toLowerCase().includes(keyword) ||
    c.name.toLowerCase().includes(keyword) ||
    c.district.toLowerCase().includes(keyword) ||
    c.status.toLowerCase().includes(keyword)
  );
  renderComplaints({ success: true, data: filtered });
}

function filterStatus(status) {
  if (status === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
    renderComplaints({ success: true, data: window._allComplaints });
  } else {
    const filtered = window._allComplaints.filter(c => c.status === status);
    renderComplaints({ success: true, data: filtered });
  }
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü
function loadStatistics() {
  const query = `action=getStatistics&sheetId=${SHEET_ID}&callback=renderStatistics`;
  const script = document.createElement('script');
  script.src = `${API_URL}?${query}`;
  document.body.appendChild(script);
}

function renderStatistics(response) {
  if (!response.success) return;
  const ctx1 = document.getElementById('totalStatsChart').getContext('2d');
  const ctx2 = document.getElementById('monthlyStatsChart').getContext('2d');

  new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: ['‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'],
      datasets: [{
        data: [response.done, response.pending],
        backgroundColor: ['#16a34a', '#facc15']
      }]
    }
  });

  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: response.months,
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
        data: response.monthCounts,
        backgroundColor: '#2563eb'
      }]
    }
  });
}

function loadComplaints() {
  const query = `action=getComplaints&sheetId=${SHEET_ID}&callback=renderComplaints`;
  const script = document.createElement('script');
  script.src = `${API_URL}?${query}`;
  document.body.appendChild(script);
}

window.onload = () => {
  loadComplaints();
  loadStatistics();
};
</script>
</body>
</html>
